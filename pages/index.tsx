import type { NextPage } from 'next'
import Head from 'next/head'
import styles from '../styles/Main.module.css'
import React, { useState } from "react";
import dynamic from "next/dynamic";
import Header from './components/Header/Header';

//server imports
import { CacheManager, CACHE_KEYS } from '../helpers/CacheManager';
import SideBar from './components/SideBar/SideBar';
import { Skill } from '../helpers/Types';

const Home: NextPage = (props:any) => {
  const Map = dynamic(
    () => import("./components/SkillTree/SkillTree"), 
    { ssr: false }
  );

  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Header />
      <div className={styles.contentContainer}>
        <SideBar skillTrees={props.skillTrees}/>
        <Map skills={props.skills}/>
      </div>
    </div>
  )
}

export const getServerSideProps = async () => {
  //get skill trees
  const skillTrees = await CacheManager.get(CACHE_KEYS.SKILLTREES)

  //get skills that are needed by the skill tree
  let skills: Array<Array<Skill>> = [];
  if(skillTrees.data?.[0].skills){
    //get all skills
    const allSkills = await CacheManager.get(CACHE_KEYS.SKILLS)
    //get skills needed by each row
    const skillsNeeded = JSON.parse(skillTrees.data[0].skills);
    for (let row of skillsNeeded){
      const rowSkills: Array<Skill> = [];
      for(let skillId of row){
        if (allSkills?.data?.find?.((s:any) => s.id == skillId)) rowSkills.push(allSkills.data.find((s:any) => s.id == skillId));
      }
      skills.push(rowSkills);
    }
  }
  
  return {
      props:{
        skillTrees:skillTrees.data,
        skills
      }
  }
}



export default Home
